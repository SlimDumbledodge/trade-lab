generator client {
  provider = "prisma-client"
  output = "./generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           Int        @id @default(autoincrement())
  email        String     @unique
  username     String     @unique
  passwordHash String
  createdAt    DateTime   @default(now())
  portfolio    Portfolio?
}

model Portfolio {
  id            Int                @id @default(autoincrement())
  userId        Int                @unique
  cashBalance   Decimal            @default(10000.00)
  holdingsValue Decimal            @default(0)
  createdAt     DateTime           @default(now())
  user          User               @relation(fields: [userId], references: [id])
  assets        PortfolioAsset[]
  history       PortfolioHistory[]
  transactions  Transaction[]
}

model Asset {
  id              Int              @id @default(autoincrement())
  symbol          String           @unique
  name            String
  description     String?
  lastPrice       Decimal
  updatedAt       DateTime         @default(now())
  prices          AssetPrice[]
  portfolioAssets PortfolioAsset[]
  transactions    Transaction[]
}

model Transaction {
  id          Int             @id @default(autoincrement())
  portfolioId Int
  assetId     Int
  type        TransactionType
  quantity    Decimal
  price       Decimal
  createdAt   DateTime        @default(now())
  asset       Asset           @relation(fields: [assetId], references: [id])
  portfolio   Portfolio       @relation(fields: [portfolioId], references: [id])
}

model PortfolioAsset {
  id              Int       @id @default(autoincrement())
  portfolioId     Int
  assetId         Int
  quantity        Decimal
  averageBuyPrice Decimal
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now())
  asset           Asset     @relation(fields: [assetId], references: [id])
  portfolio       Portfolio @relation(fields: [portfolioId], references: [id])

  @@unique([portfolioId, assetId])
}

model AssetPrice {
  id         Int      @id @default(autoincrement())
  assetId    Int
  timeframe  String
  open       Decimal
  high       Decimal
  low        Decimal
  close      Decimal
  volume     Decimal?
  recordedAt DateTime @default(now())
  asset      Asset    @relation(fields: [assetId], references: [id])

  @@unique([assetId, timeframe, recordedAt])
}

model PortfolioHistory {
  id            Int       @id @default(autoincrement())
  portfolioId   Int
  unrealizedPnL Decimal   @default(0)
  cashBalance   Decimal
  recordedAt    DateTime  @default(now())
  portfolio     Portfolio @relation(fields: [portfolioId], references: [id])

  @@unique([portfolioId, recordedAt])
}

enum TimeframeType {
  ONE_MIN
  ONE_HOUR
  ONE_DAY
  ONE_WEEK
  ONE_MONTH
}

enum TransactionType {
  buy
  sell
}
