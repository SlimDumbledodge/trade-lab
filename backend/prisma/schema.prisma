generator client {
  provider = "prisma-client"
  output = "./generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      Int        @id @default(autoincrement())
  email                   String     @unique
  username                String     @unique
  avatarPath              String     @unique @default("")
  passwordHash            String
  resetPasswordToken      String?
  resetPasswordExpires    DateTime?
  createdAt               DateTime   @default(now())
  portfolio               Portfolio?
}

model Portfolio {
  id              Int                @id @default(autoincrement())
  userId          Int                @unique
  cashBalance     Decimal            @default(10000.00)
  holdingsValue   Decimal            @default(0)
  totalValue      Decimal            @default(10000.00)
  totalPnl        Decimal            @default(0)
  totalPnlPercent Decimal            @default(0)
  createdAt       DateTime           @default(now())
  user            User               @relation(fields: [userId], references: [id])
  portfolioAssets PortfolioAsset[]
  history         PortfolioSnapshots[]
  transactions    Transaction[]
}

model Asset {
  id              Int              @id @default(autoincrement())
  symbol          String           @unique
  name            String
  lastPrice       Decimal
  // Correspond à (Bid + Ask) / 2
  midPrice        Decimal         @default(0)
  bidPrice        Decimal         @default(0)
  askPrice        Decimal         @default(0)
  quoteTimestamp  DateTime        @default(now())
  // Volume d'actions pour le plus petit côté entre bid et ask (Math.min(bidSize, askSize))
  quoteVolume       Decimal         @default(0)
  // Performance du jour en pourcentage par rapport au close de la veille
  todayPerformance Decimal?       @default(0)
  logo            String          @default("")
  category        String          @default("")
  updatedAt       DateTime        @default(now())
  prices          AssetPrice[]
  portfolioAssets PortfolioAsset[]
  transactions    Transaction[]
}

model Transaction {
  id          Int             @id @default(autoincrement())
  portfolioId Int
  assetId     Int
  type        TransactionType
  quantity    Decimal
  price       Decimal
  createdAt   DateTime        @default(now())
  asset       Asset           @relation(fields: [assetId], references: [id])
  portfolio   Portfolio       @relation(fields: [portfolioId], references: [id])
}

model PortfolioAsset {
  id              Int       @id @default(autoincrement())
  portfolioId     Int
  assetId         Int
  quantity        Decimal
  averageBuyPrice Decimal
  holdingValue   Decimal   @default(0)
  unrealizedPnl   Decimal   @default(0)
  weight          Decimal   @default(0) // proportion de l'actif dans le portefeuille
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now())
  asset           Asset     @relation(fields: [assetId], references: [id])
  portfolio       Portfolio @relation(fields: [portfolioId], references: [id])

  @@unique([portfolioId, assetId])
}

model AssetPrice {
  id         Int      @id @default(autoincrement())
  assetId    Int
  timeframe  String
  open       Decimal
  high       Decimal
  low        Decimal
  close      Decimal
  volume     Decimal?
  recordedAt DateTime @default(now())
  asset      Asset    @relation(fields: [assetId], references: [id])

  @@unique([assetId, timeframe, recordedAt])
}

model PortfolioSnapshots {
  id            Int       @id @default(autoincrement())
  portfolioId   Int
  holdingsValue  Decimal
  unrealizedPnl Decimal @default(0)
  cashBalance   Decimal
  recordedAt    DateTime  @default(now())
  portfolio     Portfolio @relation(fields: [portfolioId], references: [id])

  @@unique([portfolioId, recordedAt])
  @@index([portfolioId, recordedAt])
}

model MarketCalendar {
  id              Int      @id @default(autoincrement())
  date            String @unique
  openTime        DateTime
  closeTime       DateTime
  createdAt       DateTime @default(now())
}


enum TransactionType {
  buy
  sell
}
